<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,100,300,900,700">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
          rel='stylesheet'/>
    <style type="text/css">
        body {
            background-color: #f2f2f2;
            margin: 0px;
            padding: 0px;
            font-family: 'Lato', sans-serif !important;
        }

        .wrapper {
            max-width: 768px;
            margin: 15px auto 0px;
            background-color: #FFF;
            padding: 20px;
            box-shadow: 0 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .trip-detail {
            display: -webkit-box;
            display: -moz-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-flow: row wrap;
            flex-flow: row wrap;
        }

        .trip-detail div {
            flex: 1 1 auto;
        }

        .trip-detail div:nth-of-type(3) {
            flex: 1 1 100%;
            margin: 20px 0px 20px;
            border: 1px solid #e2e2e2;
            padding: 4px;
        }

        .trip-detail div:nth-of-type(4) {
            flex: 1 1 48%;
            border: solid 1px #e2e2e2;
            padding: 10px;
            margin-right: 2%;
        }

        .trip-detail div:nth-of-type(4) span i {
            display: inline-block;
            padding: 6px;
            border-radius: 100%;
            background-color: #5cb85c;
            margin-right: 8px;
        }

        .trip-detail div:nth-of-type(4) span, .trip-detail div:nth-of-type(5) span {
            font-weight: 600;
        }

        .trip-detail div:nth-of-type(4) p, .trip-detail div:nth-of-type(5) p {
            font-size: 12px;
            margin-top: 5px;
        }

        .trip-detail div:nth-of-type(5) {
            flex: 1 1 48%;
            border: solid 1px #e2e2e2;
            padding: 10px;
            margin-left: 2%;
        }

        .trip-detail div:nth-of-type(5) span i {
            display: inline-block;
            padding: 6px;
            border-radius: 100%;
            background-color: #d9534f;
            margin-right: 8px;
        }

        .table tbody tr td {
            border: none;
            padding: 0px 6px;
        }

        .table tbody tr td:first-child {
            color: #666;
        }

        .poweredBy {
            margin: 20px 0px 5px;
            text-align: center;
            color: #666;
            width: 100%;
            font-size: 12px;
        }

        .text-success {
            color: #5cb85c;
        }

        .text-danger {
            color: #d9534f;
        }

        .table {
            margin-bottom: 0px;
        }

        .leaflet-map-pane {
            z-index: 2 !important;
        }

        .leaflet-google-layer {
            z-index: 1 !important;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        @media only screen and (max-width: 768px) {
            .trip-detail div:nth-of-type(1) {
                height: auto;
            }

            .trip-detail div:nth-of-type(1) table td:first-child,
            .trip-detail div:nth-of-type(2) table td:first-child {
                width: 100px;
            }

            .trip-detail div:nth-of-type(4), .trip-detail div:nth-of-type(5) {
                flex: 1 1 100%;
                margin: 10px 0px;
            }

            .trip-detail div:nth-of-type(3) {
                margin: 10px 0px 20px;
            }

            #map {
                width: 100%;
                height: 350px;
            }
        }
    </style>


    <script src="js/leaflet.js"></script>
    <script src="https://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="js/leaflet-google.js"></script>
    <script type="text/javascript" src="MovingMarker.js"></script>
    <!--<script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>


    <script src="marker_rotate.js"></script>
    <script src="socket.io-1.3.5.js"></script>
    <script src="latlog.js"></script>

</head>
<body>

<div class="wrapper">
    <div class="trip-detail">
        <div>
            <table class="table">
                <tbody>
                <tr>
                    <td>Trip Status</td>
                    <td><b class="text-success" id="tripheading"></b></td>
                </tr>
                <tr>
                    <td>Date</td>
                    <td><span id="date"></span></td>
                </tr>
                <tr>
                    <td>Passenger</td>
                    <td><span id="riderName"></span></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div>
            <table class="table">
                <tbody>
                <tr>
                    <td>Driver</td>
                    <td><a id="callme" href="tel:"><i class="glyphicon glyphicon-phone"></i> </a>
                        <span id="driverVNOName"></span>
                    </td>
                </tr>
                <tr>
                    <td>Trip Id</td>
                    <td><span id="tripid"></span></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="map"></div>

        <div>
            <span class="text-success"><i></i>Pickup Location</span>
            <span class="text-success pull-right" id="pickupTime"></span>

            <p id="pickuploc"></p>
        </div>
        <div>
            <span class="text-danger"><i></i>Drop Location</span>
            <span class="text-danger pull-right" id="dropTime"></span>

            <p id="droploc"></p>
        </div>
    </div>


    <p class="poweredBy">Powered by <a href="#">Tuktuk</a></p>
</div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>


<script>
    var search = window.location.search;
    var token;
    var tripId;
    if (search) {
        search.split('&').forEach(function (qs) {
            console.log(qs);
            qs = qs.split('=');
            if ('token' === qs[0] || '?token' === qs[0]) {
                token = qs[1];
            }
        });
    }
    if (!token) {
        alert('Invalid token');
    }

    var roughtPoint = [];
    //    roughtPoint.push(new L.LatLng(22.717541, 75.872406));
    //    roughtPoint.push(new L.LatLng(22.718288, 75.871875));
    //    roughtPoint.push(new L.LatLng(22.719367, 75.871178));
    //    roughtPoint.push(new L.LatLng(22.720139, 75.870861));
    //    roughtPoint.push(new L.LatLng(22.720505, 75.872905));
    //    roughtPoint.push(new L.LatLng(22.720505, 75.872905));
    //
    //    roughtPoint.push(new L.LatLng(22.721054, 75.875389));

    function drawRought() {
        route = new L.Polyline(roughtPoint, {
            weight: 3,
            opacity: 0.5,
            smoothFactor: 1
        }).addTo(map);
        route.bringToFront();
    }

    var googleLayer = new L.Google('ROADMAP');

    //    function renderMap() {
    //        $("#mymap").append("<div  class='map-restore' id='map' style='width:100%; height:100%;'></div>")
    //        map = new L.Map('map', {
    //            fullscreenControl: false,
    //            // OR
    ////        fullscreenControl: {
    ////            pseudoFullscreen: true // if true, fullscreen to page width and height
    ////        },
    //            zoomControl: false,
    //            center: new L.LatLng(lt, ln), zoom: 11
    //        });
    //        //map.addLayer(new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));
    //        map.addLayer(googleLayer);
    //    }
    //

    var socket = io.connect('https://stg-api.gotuktuk.in?requestState=1&token=' + token, {path: '/ws'});
    //  var socket = io.connect('http://localhost:8080/?requestState=1&token=' + token, {path: '/tk'});

    var autoIcon = L.icon({
        iconUrl: 'rickshaw.png',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [12, 24]
    });

    var pickupIcon = L.icon({
        iconUrl: 'pickup.png',
        iconSize: [32, 32],
        iconAnchor: [30, 0],
        popupAnchor: [0, 0]
    });

    var dropIcon = L.icon({
        iconUrl: 'drop.png',
        iconSize: [32, 32],
        iconAnchor: [30, 0],
        popupAnchor: [0, 0]
    });

    var selfIcon = L.icon({
        iconUrl: 'current-location.png',
        iconSize: [24, 24]
    });

    var map = new L.Map('map', {
        fullscreenControl: true,
        // OR
        fullscreenControl: {
            pseudoFullscreen: true // if true, fullscreen to page width and height
        },
        center: new L.LatLng(22.7228, 75.8737), zoom: 14
    });

    //map.addLayer(new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));
    map.addLayer(googleLayer);

    var autoMarker;
    var selfMarker;

    var angle = 0;
    var currentSocket;
    var allTracks = [];
    var unfilteredTracks = [];

    function addHandlers(socket) {
        var currentLoc;
        socket.on('on_trip_track', function (track) {
            unfilteredTracks.push(track);
            if (currentLoc && currentLoc.ts > track.ts) {
                console.log('skipping track - ', track, ' it was older than the current one', currentLoc);
                return;
            }
            allTracks.push(track);
            console.log('got trip track', track);
            if (!autoMarker) {
                autoMarker = L.marker([track.lt, track.ln], {iconAngle: track.brg, icon: autoIcon});
                map.addLayer(autoMarker);
            } else {
                angle = getAngle(currentLoc.lt, currentLoc.ln, track.lt, track.ln);
                var newPoint = new L.LatLng(track.lt, track.ln);
                map.removeLayer(autoMarker);
                autoMarker = L.Marker.movingMarker([[currentLoc.lt, currentLoc.ln], [track.lt, track.ln]],
                        [500], {iconAngle: angle, icon: autoIcon}).addTo(map);
                autoMarker.setIconAngle(angle);
                autoMarker.start();
                L.polyline([new L.LatLng(currentLoc.lt, currentLoc.ln), newPoint], {color: 'red'}).addTo(map);
            }
            currentLoc = track;
//          map.setView(new L.LatLng(track.lt, track.ln), 16);
        });

        socket.on('on_invoice', function (trip) {
            console.log('on_invoice', trip);
            //document.getElementById('dropsection').setAttribute("style", "display: block;");
            document.getElementById('tripheading').innerHTML = 'TRIP COMPLETED';
            var dAdd = (trip.endPointActual || {}).address;
            var drop = dAdd.line1 + ', ' + (dAdd.line2 ? dAdd.line2 + ', ' : '') + '<p>' + dAdd.city + ', ' + dAdd.state + ', ' + dAdd.country + '</p>';
            document.getElementById("droploc").innerHTML = drop;
            var dropDate = new Date(trip.dropOn * 1000);
            document.getElementById('dropTime').innerHTML = convertTime(dropDate)//dropDate.getHours() + ":" + dropDate.getMinutes();
            var dropMarker = L.marker([trip.endPointActual.lt, trip.endPointActual.ln], {icon: dropIcon});
            dropMarker.bindPopup("<b>End Point!</b>").openPopup();
            map.addLayer(dropMarker);
            ;

            console.log('****TRIP END****');
//            console.log('ALL TRACKS', allTracks.length);
//            JSON.stringify(allTracks);
//
//            console.log('------------');
//            console.log('UnFiltered TRACKS', unfilteredTracks.length);
//            JSON.stringify(unfilteredTracks);
        });

        socket.on('on_trip_start', function (data) {
            console.log('on_trip_start', data);
            document.getElementById('tripheading').innerHTML = 'TRIP STARTED(FOR TRIP)';
            var dropMarker = L.marker([data.location.lt, data.location.ln]);
            dropMarker.bindPopup("<b>Trip Start Point!</b>").openPopup();
            map.addLayer(dropMarker);
        });


        socket.on('on_trip_pickup', function (data) {
            console.log('on_trip_pickup', data);
            document.getElementById('tripheading').innerHTML = 'TRIP PICKUP(IN TRIP)';
            var dropMarker = L.marker([data.location.lt, data.location.ln]);
            dropMarker.bindPopup("<b>Actual Pickup Point!</b>").openPopup();
            map.addLayer(dropMarker);
        });

        socket.on('on_at_pickup', function (data) {
            console.log('on_at_pickup', data);
            document.getElementById('tripheading').innerHTML = 'TRIP AT PICKUP';
            var dropMarker = L.marker([data.location.lt, data.location.ln]);
            dropMarker.bindPopup("<b>At Pickup Point!</b>").openPopup();
            map.addLayer(dropMarker);
        });

        socket.on('connect', function () {
            console.log('****CONNECTED*****');

            socket.emit('subscribe_trip_track', function (err, trip) {
                if (err) {
                    console.log('=>Error', err);
                    return;
                }
                console.log('=>Trip - ', trip);
                if (trip) {
                    setTripDetails(trip);
                } else {
                    console.log('Got empty trip');
                    //alert('Invalid request token');
                }
            })
        });
    }

    function setTripDetails(trip) {
        if (trip.driver && trip.driver.id) {
            document.getElementById("driverVNOName").innerHTML = trip.driver.fnm + " " + (trip.driver.lnm ? trip.driver.lnm : "") + " - " + trip.driver.vn;
            document.getElementById("callme").setAttribute('href','tel:'+trip.driver.phn);
        }
        //
        if (trip.rider && trip.rider.id) {
            document.getElementById("riderName").innerHTML = trip.rider.fnm
        }
        document.getElementById("tripid").innerHTML = trip.id;
        var pAdd = trip.pickupPointRequest.address;
        var pickup = pAdd.line1 + ', ' + (pAdd.line2 ? pAdd.line2 + ', ' : '') + '<p>' + pAdd.city + ', ' + pAdd.state + ', ' + pAdd.country + '</p>';
        document.getElementById("pickuploc").innerHTML = pickup;
        var pickupDate = new Date(trip.pickupOn * 1000);
        document.getElementById('pickupTime').innerHTML = convertTime(pickupDate);// pickupDate.getHours() + ":" + pickupDate.getMinutes();

        if (trip.state === 60 || trip.state === 61 || trip.state === 100) {
            //document.getElementById('dropsection').setAttribute("style", "display: block;");
            document.getElementById('tripheading').innerHTML = 'TRIP COMPLETED';
            var dAdd = (trip.endPointActual || {}).address;
            var drop = dAdd.line1 + ', ' + (dAdd.line2 ? dAdd.line2 + ', ' : '') + '<p>' + dAdd.city + ', ' + dAdd.state + ', ' + dAdd.country + '</p>';
            document.getElementById("droploc").innerHTML = drop;
            var dropDate = new Date(trip.dropOn * 1000);
            document.getElementById('dropTime').innerHTML = convertTime(dropDate);//  dropDate.getHours() + ":" + dropDate.getMinutes();
            //Drop location
            var dropMarker = L.marker([trip.endPointActual.lt, trip.endPointActual.ln], {icon: dropIcon});
            dropMarker.bindPopup("<b>Trip Drop Point!</b>").openPopup();
            map.addLayer(dropMarker);

        } else {
            document.getElementById('tripheading').innerHTML = 'TRIP IN PROGRESS';
            //document.getElementById('dropsection').setAttribute("style", "display: none;");
        }

        if ([70, 71, 80, 81].indexOf(trip.state) > -1) {
            document.getElementById('tripheading').innerHTML = 'TRIP FAILED';
        }

        //Actual Pickup Point
        if (trip.pickupPointActual) {
            var marker = L.marker([trip.pickupPointActual.lt, trip.pickupPointActual.ln], {icon: pickupIcon});
            marker.bindPopup("<b>Actual Pickup Point!</b>").openPopup();
            map.addLayer(marker);
        } else {
            var marker = L.marker([trip.pickupPointRequest.lt, trip.pickupPointRequest.ln], {icon: pickupIcon});
            marker.bindPopup("<b>Requested Pickup Point!</b>").openPopup();
            map.addLayer(marker);
        }
        showDate(trip.pickupOn * 1000);
    }

    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    var days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    function convertTime(date) {
        var dt = date
        var day = days[dt.getDay()];
        var hr = dt.getHours();
        var min = dt.getMinutes();
        if (min < 10) {
            min = "0" + min;
        }
        var h = hr;
        if (h >= 12) {
            h = hr - 12;
        }
        if (h == 0) {
            h = 12;
        }
        var ampm = hr < 12 ? "am" : "pm";
        return h + ":" + min + " " + ampm;
    }

    function showDate(date) {
        console.log(date)
        var dt = new Date(date)

        var day = days[dt.getDay()];
        var hr = dt.getHours();
        var min = dt.getMinutes();
        if (min < 10) {
            min = "0" + min;
        }
        var h = hr;
        if (h >= 12) {
            h = hr - 12;
        }
        if (h == 0) {
            h = 12;
        }
        var ampm = hr < 12 ? "am" : "pm";
        var date = dt.getDate();
        var month = months[dt.getMonth()];
        var year = dt.getFullYear();
        var x = document.getElementById("time");
        var dn = day + " " + h + ":" + min + " " + ampm + " " + date + " " + month + " " + year;
        $("#date").html(dn);
    }

    function getAngle(lt1, ln1, lt2, ln2) {
        var p1 = new LatLon(lt1, ln1);
        var p2 = new LatLon(lt2, ln2);
        return p1.bearingTo(p2);
    }

    addHandlers(socket);

</script>
</body>
</html>
