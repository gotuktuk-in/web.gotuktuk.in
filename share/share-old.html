<html>
<head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
          rel='stylesheet'/>

    <style type="text/css">
  html{font-family:sans-serif;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}body{margin:0}.clearfix{clear:both}
  article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}
  audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}
  [hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}b,strong{font-weight:bold}
  abbr[title]{border-bottom:1px dotted}dfn{font-style:italic}h1{margin:.67em 0;font-size:2em}sup{top:-.5em}sub{bottom:-.25em}
  mark{color:#000;background:#ff0}small{font-size:80%}button{overflow:visible}optgroup{font-weight:bold}
  sub,sup{position:relative;font-size:75%;line-height:0;vertical-align:baseline}figure{margin:1em 40px}
  button,select{text-transform:none}img{border:0}svg:not(:root){overflow:hidden}
  hr{height:0;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input{line-height:normal}
  pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}
  button,input,optgroup,select,textarea{margin:0;font:inherit;color:inherit}legend{padding:0;border:0}textarea{overflow:auto}
  button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
  button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}
  input[type="checkbox"],
  input[type="radio"]{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:0}
  input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}
  input[type="search"]{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;
    -webkit-appearance:textfield}fieldset{padding:.35em .625em .75em;margin:0 2px;border:1px solid #c0c0c0}
    input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
    .container{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}
    .pull-left{float:left !important}.pull-right{float:right !important}
    @media (min-width:768px){
      .container{width:750px}
    }
/*@media (min-width:992px){
  .container{width:970px}
  }*/
  .row{margin-right:-15px;margin-left:-15px}
  .col-xs-1,.col-sm-1,.col-md-1,.col-lg-1,.col-xs-2,.col-sm-2,.col-md-2,.col-lg-2,.col-xs-3,.col-sm-3,.col-md-3,.col-lg-3,
  .col-xs-4,.col-sm-4,.col-md-4,.col-lg-4,.col-xs-5,.col-sm-5,.col-md-5,.col-lg-5,.col-xs-6,.col-sm-6,.col-md-6,.col-lg-6,
  .col-xs-7,.col-sm-7,.col-md-7,.col-lg-7,.col-xs-8,.col-sm-8,.col-md-8,.col-lg-8,.col-xs-9,.col-sm-9,.col-md-9,.col-lg-9,
  .col-xs-10,.col-sm-10,.col-md-10,.col-lg-10,.col-xs-11,.col-sm-11,.col-md-11,.col-lg-11,.col-xs-12,.col-sm-12,.col-md-12,
  .col-lg-12{position:relative;min-height:1px;padding-right:15px;padding-left:15px}.col-xs-1,.col-xs-2,.col-xs-3,.col-xs-4,
  .col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-10,.col-xs-11,.col-xs-12{float:left}.col-xs-12{width:100%}
  .col-xs-11{width:91.66666667%}.col-xs-10{width:83.33333333%}.col-xs-9{width:75%}.col-xs-8{width:66.66666667%}
  .col-xs-7{width:58.33333333%}.col-xs-6{width:50%}.col-xs-5{width:41.66666667%}.col-xs-4{width:33.33333333%}
  .col-xs-3{width:25%}.col-xs-2{width:16.66666667%}.col-xs-1{width:8.33333333%}.col-xs-pull-12{right:100%}
  .col-xs-pull-11{right:91.66666667%}.col-xs-pull-10{right:83.33333333%}.col-xs-pull-9{right:75%}
  .col-xs-pull-8{right:66.66666667%}.col-xs-pull-7{right:58.33333333%}.col-xs-pull-6{right:50%}
  .col-xs-pull-5{right:41.66666667%}.col-xs-pull-4{right:33.33333333%}.col-xs-pull-3{right:25%}
  .col-xs-pull-2{right:16.66666667%}.col-xs-pull-1{right:8.33333333%}.col-xs-pull-0{right:auto}.col-xs-push-12{left:100%}
  .col-xs-push-11{left:91.66666667%}.col-xs-push-10{left:83.33333333%}.col-xs-push-9{left:75%}.col-xs-push-8{left:66.66666667%}
  .col-xs-push-7{left:58.33333333%}.col-xs-push-6{left:50%}.col-xs-push-5{left:41.66666667%}.col-xs-push-4{left:33.33333333%}
  .col-xs-push-3{left:25%}.col-xs-push-2{left:16.66666667%}.col-xs-push-1{left:8.33333333%}.col-xs-push-0{left:auto}
  .col-xs-offset-12{margin-left:100%}.col-xs-offset-11{margin-left:91.66666667%}.col-xs-offset-10{margin-left:83.33333333%}
  .col-xs-offset-9{margin-left:75%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-7{margin-left:58.33333333%}
  .col-xs-offset-6{margin-left:50%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-4{margin-left:33.33333333%}
  .col-xs-offset-3{margin-left:25%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-1{margin-left:8.33333333%}
  .col-xs-offset-0{margin-left:0}
  @media (min-width:768px){
    .col-sm-1,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-10,.col-sm-11,
    .col-sm-12{float:left}.col-sm-12{width:100%}.col-sm-11{width:91.66666667%}.col-sm-10{width:83.33333333%}
    .col-sm-9{width:75%}.col-sm-8{width:66.66666667%}.col-sm-7{width:58.33333333%}.col-sm-6{width:50%}
    .col-sm-5{width:41.66666667%}.col-sm-4{width:33.33333333%}.col-sm-3{ width:25%}.col-sm-2{width:16.66666667%}
    .col-sm-1{width:8.33333333%}.col-sm-pull-12{right:100%}.col-sm-pull-11{right:91.66666667%}
    .col-sm-pull-10{right:83.33333333%}.col-sm-pull-9{right:75%}.col-sm-pull-8{right:66.66666667%}
    .col-sm-pull-7{right:58.33333333%}.col-sm-pull-6{right:50%}.col-sm-pull-5{right:41.66666667%}
    .col-sm-push-8{left:66.66666667%}.col-sm-push-7{left:58.33333333%}.col-sm-push-6{left:50%}.col-sm-push-5{left:41.66666667%}.col-sm-push-4{left:33.33333333%}.col-sm-push-3{left:25%}.col-sm-push-2{left:16.66666667%}.col-sm-push-1{left:8.33333333%}.col-sm-push-0{left:auto}.col-sm-offset-12{margin-left:100%}.col-sm-offset-11{margin-left:91.66666667%}
    .col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-8{margin-left:66.66666667%}
    .col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-6{ margin-left:50%}.col-sm-offset-5{margin-left:41.66666667%}
    .col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-2{margin-left:16.66666667%}
    .col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-0{margin-left:0}
  }
  @font-face{font-family:'allerbold';src:url('fonts/aller/aller_std_bd.eot');src:url('fonts/aller/aller_std_bd.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_bd.woff2') format('woff2'),
  url('fonts/aller/aller_std_bd.woff') format('woff'), url('fonts/aller/aller_std_bd.ttf') format('truetype'),
  url('fonts/aller/aller_std_bd.svg#allerbold') format('svg');font-weight:normal;font-style:normal}
  @font-face{font-family:'allerbold_italic';src:url('fonts/aller/aller_std_bdit.eot');src:url('fonts/aller/aller_std_bdit.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_bdit.woff2') format('woff2'), url('fonts/aller/aller_std_bdit.woff') format('woff'), url('fonts/aller/aller_std_bdit.ttf') format('truetype'), url('fonts/aller/aller_std_bdit.svg#allerbold_italic') format('svg');font-weight:normal;
  font-style:normal}
  @font-face{font-family:'alleritalic';src:url('fonts/aller/aller_std_it.eot');src:url('fonts/aller/aller_std_it.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_it.woff2') format('woff2'), url('fonts/aller/aller_std_it.woff') format('woff'), url('fonts/aller/aller_std_it.ttf') format('truetype'), url('fonts/aller/aller_std_it.svg#alleritalic') format('svg');font-weight:normal;font-style:normal}
  @font-face{font-family:'allerlight';src:url('fonts/aller/aller_std_lt.eot');src:url('fonts/aller/aller_std_lt.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_lt.woff2') format('woff2'), url('fonts/aller/aller_std_lt.woff') format('woff'), url('fonts/aller/aller_std_lt.ttf') format('truetype'), url('fonts/aller/aller_std_lt.svg#allerlight') format('svg');font-weight:normal;font-style:normal}
  @font-face{font-family:'allerlight_italic';src:url('fonts/aller/aller_std_ltit.eot');src:url('fonts/aller/aller_std_ltit.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_ltit.woff2') format('woff2'), url('fonts/aller/aller_std_ltit.woff') format('woff'), url('fonts/aller/aller_std_ltit.ttf') format('truetype'), url('fonts/aller/aller_std_ltit.svg#allerlight_italic') format('svg');font-weight:normal;
  font-style:normal}
  @font-face{font-family:'allerregular';src:url('fonts/aller/aller_std_rg.eot');src:url('fonts/aller/aller_std_rg.eot?#iefix') format('embedded-opentype'), url('fonts/aller/aller_std_rg.woff2') format('woff2'), url('fonts/aller/aller_std_rg.woff') format('woff'), url('fonts/aller/aller_std_rg.ttf') format('truetype'), url('fonts/aller/aller_std_rg.svg#allerregular') format('svg');font-weight:normal;font-style:normal}
  @font-face{font-family:'aller_displayregular'; src:url('fonts/aller/allerdisplay_std_rg.eot'); src:url('fonts/aller/allerdisplay_std_rg.eot?#iefix') format('embedded-opentype'), url('fonts/aller/allerdisplay_std_rg.woff2') format('woff2'), url('fonts/aller/allerdisplay_std_rg.woff') format('woff'), url('fonts/aller/allerdisplay_std_rg.ttf') format('truetype'), url('fonts/aller/allerdisplay_std_rg.svg#aller_displayregular') format('svg');font-weight:normal;font-style:normal}
  .b47TT-journeyDetailBox{border:solid 1px #000; padding:22px}
  .b47TT-journeyDetailBox p{margin:0;font-family:'allerlight'; font-size:25.95px; line-height:36px}
  .b47TT-journeyStartPoint{ margin:40px 0 0 0; display:block;}
  .b47TT-journeyStartPoint strong, .b47TT-journeyEndPoint strong{font-size:26.83px; color:#68c663; line-height:100%; margin:0 0 20px 0; display:block}
  .b47TT-heading2{color:#116cb3; font-size:30px;font-family:'allerlight'}
  .b47TT-driverDetailQuad1{border-bottom:solid 1px #8d8d8d;padding-bottom:36px}
  .b47TT-driverDetailQuad1 strong{text-transform:uppercase; color:#333; font-size:26.83px;font-family:'allerbold';}
  .b47TT-driverDetailQuad2{text-transform:uppercase; color:#333; font-size:26.83px;font-family:'allerlight';}
  .b47TT-startTimeQuad, .b47TT-endTimeQuad{color:#116cb3; font-size:25.95px; line-height:100%}
  .b47TT-mapQuad{margin:40px 0; display:block;}

  @media(max-width:520px){
    .b47TT-driverDetailQuad2{text-align:left; width:100%}
  }
  .leaflet-map-pane {
      z-index: 2 !important;
  }

  .leaflet-google-layer {
      z-index: 1 !important;
  }

  </style>
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="http://matchingnotes.com/javascripts/leaflet-google.js"></script>
    <script type="text/javascript" src="MovingMarker.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

    <script src="marker_rotate.js"></script>
  <script src="socket.io-1.3.5.js"></script>
</head>
<body>
  <div class="b47TT-wrapper">
      <div class="">
          <div class="container">
              <h2 class="b47TT-heading2" id="tripheading"></h2>
              <div class="b47TT-driverDetailQuad1">
                  <strong class="pull-left">DRIVER</strong>
                  <span id="driverinfo" class="pull-right b47TT-driverDetailQuad2"></span>
                  <div class="clearfix"></div>
              </div>
          </div>


      </div>
      <div class="">
          <div class="container">
              <div class="b47TT-journeyStartPoint">
                  <strong class="pull-left">PICKUP</strong>
                  <span class="pull-right b47TT-startTimeQuad" id="pickupTime"></span>
                  <div class="clearfix"></div>
                  <div class="b47TT-journeyDetailBox">
                      <p id="pickuploc"></p>

                      <div class="clearfix"></div>
                  </div>
              </div>
              <div class="b47TT-mapQuad">
                  <!-- <img src="images/map-img.png" alt="" style="width:100%; height:auto"> -->
                  <div style="width:100%; height:388px" id="map"></div>
              </div>
              <div id="dropsection" class="b47TT-journeyEndPoint" style="margin-bottom:41px">
                  <strong class="pull-left" style="color:#FF0000">DROP</strong>
                  <span class="pull-right b47TT-endTimeQuad" id="dropTime"></span>
                  <div class="clearfix"></div>
                  <div id="droploc" class="b47TT-journeyDetailBox">
                      <p></p>

                      <div class="clearfix"></div>
                  </div>
              </div>
          </div>
      </div>
  </div>
  <script>
  //Parsing token from url
  var search = window.location.search;
  var token;
  var tripId;
  if(search){
    search.split('&').forEach(function(qs){
      console.log(qs);
      qs = qs.split('=');
      if('token'=== qs[0] || '?token'=== qs[0]){
        token = qs[1];
      }
    });
  }
  if(!token){
    alert('Invalid token');
  }
  // var token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJnNGdUT2c2RU9nIiwicm9sZSI6Imd1ZXN0IiwiaWF0IjoxNDUzMDUyMjUyLCJleHAiOjE0NTM0MTIyNTJ9.glP-v6dGVxn3WdcTAjuQvZmiqFuJ8P5xsNaND5upNeE';
  //Socket -
  var socket = io.connect('http://52.89.31.187:8080/?requestState=1&token=' + token, {path: '/tk'});
//  var socket = io.connect('http://localhost:8080/?requestState=1&token=' + token, {path: '/tk'});
  var autoIcon =  L.icon({
      iconUrl: 'rickshaw.png',
      iconSize: [24, 24],
      iconAnchor: [12, 12],
      popupAnchor: [12, 24]
  });

  var pickupIcon = L.icon({
      iconUrl: 'images/pickup.png',
      iconSize: [60, 60],
      iconAnchor: [30, 0],
      popupAnchor: [0, 0]
  });

  var dropIcon = L.icon({
      iconUrl: 'images/drop.png',
      iconSize: [60, 60],
      iconAnchor: [30, 0],
      popupAnchor: [0, 0]
  });

  var map = new L.Map('map', {
      fullscreenControl: true,
      // OR
      fullscreenControl: {
          pseudoFullscreen: true // if true, fullscreen to page width and height
      },
      center: new L.LatLng(22.7228, 75.8737), zoom: 14
  });
//  var map = new L.Map('map', {center: new L.LatLng(22.7228, 75.8737), zoom: 14});
//  var googleLayer = new L.Google('ROADMAP');
//  map.addLayer(googleLayer);

  map.addLayer(new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));
  var autoMarker;

  var angle = 0;

  function addHandlers(socket) {
      var currentLoc;
      socket.on('on_trip_track', function (track) {

          console.log('got trip track', track);
          if(!autoMarker){
//              autoMarker = L.marker([track.lt, track.ln], {iconAngle: 90, icon: autoIcon});
              autoMarker = L.marker([track.lt, track.ln], {icon:autoIcon});
              map.addLayer(autoMarker);
          }else{
              map.removeLayer(autoMarker);
              autoMarker = L.Marker.movingMarker([[currentLoc.lt,currentLoc.ln],[track.lt, track.ln]],
                      [500],{iconAngle:track.brg, icon:autoIcon}).addTo(map);
              autoMarker.setIconAngle(track.brg);
              autoMarker.start();
          }
          currentLoc = track;
          map.setView(new L.LatLng(track.lt, track.ln), 16);
      });

      socket.on('on_invoice', function(trip){
          console.log('on_invoice', trip);
          document.getElementById('dropsection').setAttribute("style", "display: block;");
          document.getElementById('tripheading').innerHTML = 'TRIP COMPLETED';
          var dAdd = (trip.endPointActual || {}).address;
          var drop = dAdd.line1 + ', ' + (dAdd.line2 ? dAdd.line2 + ', ' : '') + '<p>' + dAdd.city + ', ' + dAdd.state + ', ' + dAdd.country + '</p>';
          document.getElementById("droploc").innerHTML = drop;
          var dropDate = new Date(trip.dropOn * 1000);
          document.getElementById('dropTime').innerHTML = dropDate.getHours() + ":" + dropDate.getMinutes();
          var dropMarker = L.marker([trip.endPointActual.lt, trip.endPointActual.ln], {icon: dropIcon});
          dropMarker.bindPopup("<b>End Point!</b>").openPopup();
          map.addLayer(dropMarker);
      });

      socket.on('connect', function () {
          console.log('****CONNECTED*****');

          socket.emit('subscribe_trip_track', function (err, trip) {
              if (err) {
                  console.log('=>Error', err);
                  return;
              }
              console.log('=>Trip - ', trip);
              if (trip) {
                  setTripDetails(trip);
              } else {
                  console.log('Got empty trip');
                  alert('Invalid request token');
              }
          })
      });
  }

  function setTripDetails(trip) {
      if (trip.driver && trip.driver.id) {
          document.getElementById("driverinfo").innerHTML = trip.driver.fnm + ' ' + trip.driver.lnm + ' | ' + trip.driver.vn;
      }
      var pAdd = trip.pickupPointRequest.address;
      var pickup = pAdd.line1 + ', ' + (pAdd.line2 ? pAdd.line2 + ', ' : '') + '<p>' + pAdd.city + ', ' + pAdd.state + ', ' + pAdd.country + '</p>';
      document.getElementById("pickuploc").innerHTML = pickup;
      var pickupDate = new Date(trip.pickupOn * 1000);
      document.getElementById('pickupTime').innerHTML = pickupDate.getHours() + ":" + pickupDate.getMinutes();
      if (trip.state === 60 || trip.state === 61  || trip.state === 100) {
          document.getElementById('dropsection').setAttribute("style", "display: block;");
          document.getElementById('tripheading').innerHTML = 'TRIP COMPLETED';
          var dAdd = (trip.endPointActual || {}).address;
          var drop = dAdd.line1 + ', ' + (dAdd.line2 ? dAdd.line2 + ', ' : '') + '<p>' + dAdd.city + ', ' + dAdd.state + ', ' + dAdd.country + '</p>';
          document.getElementById("droploc").innerHTML = drop;
          var dropDate = new Date(trip.dropOn * 1000);
          document.getElementById('dropTime').innerHTML = dropDate.getHours() + ":" + dropDate.getMinutes();
          //Drop location
          var dropMarker = L.marker([trip.endPointActual.lt, trip.endPointActual.ln], {icon: dropIcon});
          dropMarker.bindPopup("<b>Trip Drop Point!</b>").openPopup();
          map.addLayer(dropMarker);

      } else {
          document.getElementById('tripheading').innerHTML = 'TRIP IN PROGRESS';
          document.getElementById('dropsection').setAttribute("style", "display: none;");
      }

      if ([70, 71, 80, 81].indexOf(trip.state) > -1) {
          document.getElementById('tripheading').innerHTML = 'TRIP FAILED';
      }

      //Actual Pickup Point
      if(trip.pickupPointActual){
          var marker = L.marker([trip.pickupPointActual.lt, trip.pickupPointActual.ln],{icon: pickupIcon});
          marker.bindPopup("<b>Actual Pickup Point!</b>").openPopup();
          map.addLayer(marker);
      }else{
          var marker = L.marker([trip.pickupPointRequest.lt, trip.pickupPointRequest.ln], {icon: pickupIcon});
          marker.bindPopup("<b>Requested Pickup Point!</b>").openPopup();
          map.addLayer(marker);
      }
  }
  addHandlers(socket);

  /*var mkrIcon = L.icon({
      iconUrl: 'rickshaw.png',
      iconSize: [24, 24],
      iconAnchor: [12,12],
      popupAnchor: [12,24]
  });

  var mkr;

  var angle = 0;
  function moveMarker(point) {

      if (!mkr) {
          mkr = L.marker([point[1], point[0]], {icon: mkrIcon});
          map.addLayer(mkr);
          map.setView(mkr.getLatLng(), 17);
      } else {
          var newPoint = new L.LatLng(point[1], point[0]);
          var olderPoint = new L.LatLng(mkr.getLatLng().lat, mkr.getLatLng().lng);

          map.removeLayer(mkr);
          mkr = L.Marker.movingMarker([[mkr.getLatLng().lat, mkr.getLatLng().lng], [point[1], point[0]]],
                  [500], {icon: mkrIcon}).addTo(map);

          mkr.setIconAngle(angle+=20);
          mkr.start();
          L.polyline([olderPoint, newPoint], {color: 'red'}).addTo(map);
      }

  }


  var i = 0;
  var randomPoints = [[75.87238133, 22.71742871], [75.87218821, 22.71787406], [75.87148011, 22.71880432], [75.87080419, 22.71971479], [75.87100804, 22.72017002], [75.87153375, 22.72019971], [75.87261736, 22.72035805]];
  var intervalId = setInterval(function () {
      if (i >= randomPoints.length) {
          _askToEndTrip(trip)
          clearInterval(intervalId);
          return;
      }
      moveMarker(randomPoints[i]);
      i++;
  }, 3000);*/
  </script>
</body>
</html>
